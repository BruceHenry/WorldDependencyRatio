<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="css/styles.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/datamaps/0.5.8/datamaps.all.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>


    <title>Dependency Ratio Map</title>
</head>

<body style="background-color:#feffe1">
<div id="map">
</div>

<div id="country-selector">
    <label for="country-input">Country:</label>
    <select class="form-control" id="country-input"></select>
</div>

<div id="bar">
</div>

<div id="year-selector">
    <div class="range">
        <input id="year-input" type="range" min="2015" max="2100" step="5" value="2015" autocomplete="off">
    </div>
    <ul class="range-labels">
        <li class="active selected">2015</li>
        <li>2020</li>
        <li>2025</li>
        <li>2030</li>
        <li>2035</li>
        <li>2040</li>
        <li>2045</li>
        <li>2050</li>
        <li>2055</li>
        <li>2060</li>
        <li>2065</li>
        <li>2070</li>
        <li>2075</li>
        <li>2080</li>
        <li>2085</li>
        <li>2090</li>
        <li>2095</li>
        <li>2100</li>
    </ul>
</div>


<script>
    var special = {
        900: 'World',
        1503: 'High Income Countries',
        1517: 'Middle Income Countries',
        1500: 'Low Income Countries'
    };
    var countryCode = {900: null, 1503: null, 1517: null, 1500: null};//{country numeric code : alpha 3 code}
    var codeName = {};// {alpha 3 code : country name}
    var codeValue = []; // [alpha 3 code, {year: value}]
    var countriesNames = ['World', 'High Income Countries', 'Middle Income Countries', 'Low Income Countries'];//
    var nameValue = {};//{country name: value}
    function countryCodeRow(d) {
        countryCode[d.Numeric_code] = d.Alpha_3_code;
        return 0;
    }

    function row(d) {
        if (countryCode[d.Country_code] !== undefined) {
            var rowData = {};
            for (var i = 2015; i <= 2100; i += 5) {
                rowData[i] = d[i];
            }
            if (special[d.Country_code] !== undefined)
                nameValue[special[d.Country_code]] = rowData;
            else {
                codeValue.push([countryCode[d.Country_code], rowData]);
                nameValue[d['Region, subregion, country or area *']] = rowData;
                countriesNames.push(d['Region, subregion, country or area *']);
                codeName[countryCode[d.Country_code]] = d['Region, subregion, country or area *'];
            }
        }
    }

    function render() {
        d3.select("#map").selectAll("*").remove();
        if (document.getElementById("country-input").childElementCount === 0) {
            var countryList = d3.select('#country-input');
            countryList.selectAll('*').remove();
            countriesNames.sort();
            countriesNames.unshift('World', 'High Income Countries', 'Middle Income Countries', 'Low Income Countries');
            for (var i in countriesNames)
                countryList.append('option').text(countriesNames[i]);
            $("#country-input").val("World");
        }
        var dataset = {};
        var onlyValues = codeValue.map(function (obj) {
            return obj[1][$("#year-input").val()];
        });
        var minValue = Math.min.apply(null, onlyValues);
        var maxValue = Math.max.apply(null, onlyValues);
        // create color palette function
        var paletteScale = d3.scale.linear()
            .domain([minValue, maxValue])
            .range(["#f4fff8", "#b90700"]); // blue color
        // fill dataset in appropriate format
        codeValue.forEach(function (item) { //item example value ["USA", 70]
            var iso = item[0];
            var value = item[1][$("#year-input").val()];
            dataset[iso] = {numberOfThings: value, fillColor: paletteScale(value)};
        });
        // render map
        new Datamap({
            element: document.getElementById('map'),
            projection: 'mercator', // big world map
            // countries don't listed in dataset will be painted with this color
            fills: {defaultFill: '#F5F5F5'},
            data: dataset,
            geographyConfig: {
                borderColor: '#DEDEDE',
                highlightBorderWidth: 2,
                // don't change color on mouse hover
                highlightFillColor: function (geo) {
                    return geo['fillColor'] || '#F5F5F5';
                },
                // show desired information in tooltip
                popupTemplate: function (geo, data) {
                    // don't show tooltip if country don't present in dataset
                    var popupInfo = ['<div class="hoverinfo">', '<strong>', geo.properties.name, '</strong>'];
                    if (!data) {
                        popupInfo.push('<br><strong>No Data</strong>');
                        return popupInfo.join('');
                    }
                    else
                        return popupInfo.concat(['<br>Total Dependency Ratio: <strong>',
                            data.numberOfThings, '</strong>', '</div>']).join('');
                },
                // only change border
                highlightBorderColor: '#ff5a04'
            },
            done: function (datamap) {
                datamap.svg.selectAll('.datamaps-subunit').on('click', function (geography) {
                    if (geography.id !== -99) {
                        $("#country-input").val(codeName[geography.id]);
                        drawBar(nameValue[$("#country-input").val()]);
                    }
                });
            }
        });
    }

    d3.csv("data/CountryCode.csv", countryCodeRow, function () {
            d3.csv("data/2015 to 2100 Dependency Ratio.csv", row, function () {
                render();
                drawBar(nameValue["World"]);
            });
        }
    );
</script>
<script>

    var svg = d3.select("#bar").append("svg").attr('width', '100%').attr('height', '100%');
    var barWidth = 30;

    function drawBar(yearValue) {
        var data = [];
        for (var i = 2015; i <= 2100; i += 5) {
            data.push({year: String(i), value: yearValue[i]});
        }
        const xValue = d => d.year;
        const yValue = d => +d.value;
        const xScale = d3.scale.linear()
            .domain([2015, 2100])
            .range([0, 915]);
        const yScale = d3.scale.linear()
            .range([0, 299])
            .domain([0, 256]);
        var rects = svg.selectAll('rect').data(data)
            .attr('x', d => xScale(xValue(d)) + 12)
            .attr('y', d => 300 - yScale(yValue(d)))
            .attr('width', barWidth)
            .attr('height', d => yScale(yValue(d)));

        svg.selectAll('title').data(data)
            .text(d => yValue(d));

        rects.enter().append('rect')
            .attr('class', 'year')
            .attr('id', d => 'year-' + d.year)
            .attr('x', d => xScale(xValue(d)) + 12)
            .attr('y', d => 300 - yScale(yValue(d)))
            .attr('width', barWidth)
            .attr('height', d => yScale(yValue(d)))
            .append('title')
            .attr('class', 'rect-popup')
            .text(d => yValue(d));
        $("rect:nth-child(1)").addClass("selected-year");
        $('.year').on('click', function () {
            var index = $(this).index();
            $('.range input').val(backup * 5 + 2015).trigger('input');
        });
    }
</script>

<script>
    var sheet = document.createElement('style'),
        $rangeInput = $('.range input'),
        prefs = ['webkit-slider-runnable-track', 'moz-range-track', 'ms-track'];
    document.head.appendChild(sheet);
    var getTrackStyle = function (el) {
        var curVal = el.value,
            val = (curVal - 2015) * 1.176470588,
            style = '';
        $('.range-labels  li').removeClass('active selected');
        $('svg  rect').removeClass('selected-year');
        var curLabel = $('.range-labels').find('li:nth-child(' + (curVal - 2010) / 5 + ')');
        curLabel.addClass('active selected');
        curLabel.prevAll().addClass('active selected');
        var curYear = $("svg").find('rect:nth-child(' + (curVal - 2010) / 5 + ')');
        curYear.addClass('selected-year');
        curYear.prevAll().addClass('selected-year');
        for (var i = 0; i < prefs.length; i++) {
            style += '.range {background: linear-gradient(to right, #ff5a04 0%, #ff5a04 ' + val + '%, #fff ' + val + '%, #fff 100%)}';
            style += '.range input::-' + prefs[i] + '{background: linear-gradient(to right, #ff5a04 0%, #ff5a04 ' + val + '%, #b2b2b2 ' + val + '%, #b2b2b2 100%)}';
        }
        return style;
    };
    $rangeInput.on('input', function () {
        sheet.textContent = getTrackStyle(this);
        render();
    });
    $('.range-labels li').on('click', function () {
        var index = $(this).index();
        $rangeInput.val(backup * 5 + 2015).trigger('input');
    });
    $("#country-input").change(function () {
        drawBar(nameValue[$("#country-input").val()]);
    });
</script>
</body>
</html>